<idea-plugin>
    <id>brig.concord.intellij</id>
    <name>Concord</name>
    <vendor>brig</vendor>

    <depends>com.intellij.modules.platform</depends>
    <depends optional="true" config-file="maven-integration.xml">org.jetbrains.idea.maven</depends>

    <projectListeners>
        <listener class="brig.concord.GitIgnoreChangeListener" topic="com.intellij.openapi.vcs.changes.ChangeListListener"/>
    </projectListeners>

    <extensions defaultExtensionNs="com.intellij">
        <!-- Breadcrumbs -->
        <breadcrumbsInfoProvider implementation="brig.concord.editor.ConcordBreadcrumbsProvider"/>

        <!-- Code style / formatting -->
        <virtualFileCustomDataProvider implementation="brig.concord.editing.CodeStyleSettingsCustomDataSynchronizer"/>
        <langCodeStyleSettingsProvider implementation="brig.concord.editing.CodeStyleSettingsProvider"/>

        <lang.formatter language="Concord" implementationClass="brig.concord.formatter.YAMLFormattingModelBuilder"/>
        <lang.commenter language="Concord" implementationClass="brig.concord.formatter.YAMLCommenter"/>
        <lang.whiteSpaceFormattingStrategy language="Concord"
                                           implementationClass="brig.concord.formatter.YamlWhiteSpaceFormattingStrategy"/>

        <stripTrailingSpacesFilterFactory implementation="brig.concord.formatter.YamlStripTrailingSpacesFilterFactory"/>

        <editor.backspaceModeOverride language="Concord"
                                      implementationClass="com.intellij.codeInsight.editorActions.SmartBackspaceDisabler"/>

        <!-- Editor smart actions -->
        <enterHandlerDelegate implementation="brig.concord.smart.ConcordEnterAtIndentHandler" order="first"/>

        <!-- Services / settings -->
        <applicationService serviceImplementation="brig.concord.smart.YAMLEditorOptions"/>
        <applicationSettings service="brig.concord.smart.YAMLEditorOptions"/>

        <applicationService serviceImplementation="brig.concord.run.cli.ConcordCliSettings"/>

        <projectService serviceImplementation="brig.concord.yaml.YAMLElementGenerator"/>
        <projectService serviceInterface="brig.concord.psi.ElPropertyProvider"
                        serviceImplementation="brig.concord.psi.ElPropertyProviderImpl"/>

        <!-- Syntax highlighting / colors -->
        <lang.syntaxHighlighterFactory
                language="Concord"
                implementationClass="brig.concord.highlighting.ConcordSyntaxHighlighterFactory"/>

        <annotator
                language="Concord"
                implementationClass="brig.concord.highlighting.ConcordHighlightingAnnotator"/>

        <annotator
                language="concord-el"
                implementationClass="brig.concord.highlighting.ElErrorAnnotator"/>

        <colorSettingsPage
                implementation="brig.concord.highlighting.ConcordColorSettingsPage"/>

        <!-- Color scheme additions -->
        <additionalTextAttributes scheme="Default" file="colorSchemes/ConcordDefault.xml"/>
        <additionalTextAttributes scheme="Darcula" file="colorSchemes/ConcordDarcula.xml"/>

        <!-- Language / file type -->
        <lang.parserDefinition language="Concord"
                               implementationClass="brig.concord.parser.ConcordYAMLParserDefinition"/>

        <!-- EL (Expression Language) support -->
        <fileType name="concord-el"
                  implementationClass="brig.concord.el.ElFileType"
                  fieldName="INSTANCE"
                  language="concord-el"/>
        <lang.parserDefinition language="concord-el"
                               implementationClass="brig.concord.el.ElParserDefinition"/>
        <lang.syntaxHighlighterFactory language="concord-el"
                                       implementationClass="brig.concord.el.ElSyntaxHighlighterFactory"/>

        <fileType name="Concord File"
                  implementationClass="brig.concord.ConcordFileType"
                  fieldName="INSTANCE"
                  language="Concord"
                  extensions="concord.yml"
                  patterns="*.concord.yml;concord.yml;*.concord.yaml;concord.yaml"/>

        <!-- Folding -->
        <lang.foldingBuilder language="Concord" implementationClass="brig.concord.folding.CronExpressionFolding"/>
        <lang.foldingBuilder language="Concord"
                             id="YAMLFolding"
                             implementationClass="brig.concord.yaml.folding.YAMLFoldingBuilder"/>

        <!-- Find usages / usage types -->
        <iconProvider implementation="brig.concord.psi.ConcordIconProvider" order="first"/>
        <lang.findUsagesProvider language="Concord" implementationClass="brig.concord.usages.FindUsageProvider"/>
        <usageTypeProvider implementation="brig.concord.usages.FlowUsageTypeProvider"/>

        <!-- Refactoring -->
        <renamePsiElementProcessor implementation="brig.concord.refactoring.FlowDefinitionRenameProcessor"/>

        <!-- References / completion / structure view -->
        <psi.referenceContributor language="Concord" implementation="brig.concord.ConcordYamlReferenceContributor"/>
        <psi.referenceContributor language="concord-el" implementation="brig.concord.ElReferenceContributor"/>

        <completion.contributor language="Concord"
                                implementationClass="brig.concord.completion.ConcordCompletions"
                                order="first"/>
        <completion.contributor language="Concord"
                                implementationClass="brig.concord.completion.FlowDocCompletionContributor"/>
        <completion.contributor language="concord-el"
                                implementationClass="brig.concord.completion.ElCompletionContributor"/>

        <multiHostInjector implementation="brig.concord.injection.ConcordLanguageInjector"/>

        <lang.psiStructureViewFactory language="Concord"
                                      implementationClass="brig.concord.structureView.ConcordStructureViewFactory"/>

        <!-- Navigation -->
        <fileBasedIndex implementation="brig.concord.navigation.FlowNamesIndex"/>
        <searchEverywhereContributor implementation="brig.concord.navigation.FlowDefinitionSearchEverywhereContributor$Factory"/>
        <gotoRelatedProvider implementation="brig.concord.navigation.ConcordRootGotoRelatedProvider"/>

        <editorFloatingToolbarProvider implementation="brig.concord.dependency.DependenciesRefreshFloatingProvider"/>

        <!-- Call Hierarchy -->
        <callHierarchyProvider language="Concord"
                               implementationClass="brig.concord.hierarchy.FlowCallHierarchyProvider"/>

        <!-- Documentation -->
        <platform.backend.documentation.targetProvider
                implementation="brig.concord.documentation.ConcordDocumentationTargetProvider"/>
        <platform.backend.documentation.lookupElementTargetProvider
                implementation="brig.concord.documentation.ConcordLookupDocumentationProvider"/>

        <!-- Validation -->
        <annotator language="Concord"
                   implementationClass="brig.concord.yaml.annotator.YAMLInvalidBlockChildrenErrorAnnotator"/>

        <notificationGroup id="Concord Notification Group" displayType="BALLOON" key="notification.group.concord"/>

        <editorNotificationProvider
                implementation="brig.concord.notification.OutOfScopeEditorNotificationProvider"/>

        <!-- inspections -->
        <localInspection language="Concord"
                         displayName="Unknown keys"
                         groupPath="Concord"
                         groupName="Structure"
                         enabledByDefault="true"
                         level="ERROR"
                         implementationClass="brig.concord.inspection.UnknownKeysInspection"/>
        <localInspection language="Concord"
                         displayName="Missing keys"
                         groupPath="Concord"
                         groupName="Structure"
                         enabledByDefault="true"
                         level="ERROR"
                         implementationClass="brig.concord.inspection.MissingKeysInspection"/>
        <localInspection language="Concord"
                         displayName="Scalar values"
                         groupPath="Concord"
                         groupName="Structure"
                         enabledByDefault="true"
                         level="ERROR"
                         implementationClass="brig.concord.inspection.ValueInspection"/>

        <localInspection language="Concord"
                         bundle="messages.ConcordBundle"
                         shortName="DuplicatedKeys"
                         level="ERROR"
                         key="inspections.duplicated.keys.name"
                         groupKey="inspections.group.name"
                         enabledByDefault="true"
                         implementationClass="brig.concord.inspection.DuplicatedKeysInspection"/>

        <localInspection language="Concord"
                         bundle="messages.ConcordBundle"
                         shortName="FlowDocumentation"
                         level="WARNING"
                         key="inspections.flow.documentation.name"
                         groupKey="inspections.group.name"
                         enabledByDefault="true"
                         implementationClass="brig.concord.inspection.FlowDocumentationInspection"/>

        <localInspection language="Concord"
                         bundle="messages.ConcordBundle"
                         shortName="DuplicateFlowName"
                         level="WARNING"
                         key="inspections.duplicate.flow.names.name"
                         groupKey="inspections.group.name"
                         enabledByDefault="true"
                         implementationClass="brig.concord.inspection.DuplicateFlowNameInspection"/>

        <localInspection language="Concord"
                         bundle="messages.ConcordBundle"
                         shortName="UnresolvedDependency"
                         level="ERROR"
                         key="inspections.unresolved.dependency.name"
                         groupKey="inspections.group.name"
                         enabledByDefault="true"
                         implementationClass="brig.concord.inspection.UnresolvedDependencyInspection"/>

        <localInspection language="Concord"
                         bundle="messages.ConcordBundle"
                         shortName="ServerOnlyDependency"
                         level="WEAK WARNING"
                         key="inspections.server.only.dependency.name"
                         groupKey="inspections.group.name"
                         enabledByDefault="true"
                         implementationClass="brig.concord.inspection.ServerOnlyDependencyInspection"/>

        <localInspection language="Concord"
                         bundle="messages.ConcordBundle"
                         shortName="OutOfScope"
                         level="WARNING"
                         key="inspections.out.of.scope.name"
                         groupKey="inspections.group.name"
                         enabledByDefault="true"
                         implementationClass="brig.concord.inspection.OutOfScopeInspection"/>

        <!-- Concord Settings (parent group) -->
        <applicationConfigurable
                parentId="tools"
                instance="brig.concord.settings.ConcordSettingsConfigurable"
                id="brig.concord.settings"
                bundle="messages.ConcordBundle"
                key="settings.display.name"/>

        <!-- CLI Settings -->
        <applicationConfigurable
                parentId="brig.concord.settings"
                instance="brig.concord.run.cli.ConcordCliConfigurable"
                id="brig.concord.cli.settings"
                bundle="messages.ConcordBundle"
                key="cli.settings.display.name"/>

        <!-- Project-level run mode settings -->
        <projectConfigurable
                parentId="brig.concord.settings"
                instance="brig.concord.run.ConcordRunModeConfigurable"
                id="brig.concord.run.mode.settings"
                bundle="messages.ConcordBundle"
                key="run.mode.settings.display.name"/>

        <!-- Run Configuration -->
        <configurationType implementation="brig.concord.run.ConcordRunConfigurationType"/>
        <runConfigurationProducer implementation="brig.concord.run.ConcordRunConfigurationProducer"/>

        <!-- Run Line Marker -->
        <codeInsight.lineMarkerProvider
                language="Concord"
                implementationClass="brig.concord.run.ConcordFlowRunLineMarkerProvider"/>

        <!-- Tool Window -->
        <toolWindow id="Concord"
                    anchor="right"
                    icon="brig.concord.ConcordIcons.TOOLBOX"
                    factoryClass="brig.concord.toolwindow.ConcordToolWindowFactory"/>

        <!-- Task names loading on project open -->
        <backgroundPostStartupActivity implementation="brig.concord.dependency.ConcordDependenciesStartupActivity"/>

        <problemFileHighlightFilter implementation="brig.concord.ConcordProblemFileHighlightFilter"/>

        <!-- Suppress raw EL parser errors; annotator shows simplified messages -->
        <highlightErrorFilter implementation="brig.concord.highlighting.ElHighlightErrorFilter"/>
    </extensions>

    <actions>
        <action id="Concord.RefreshProject"
                class="brig.concord.actions.RefreshConcordDependenciesAction"
                text="Refresh Concord Dependencies"
                description="Refresh Concord scopes and dependencies"
                icon="AllIcons.Actions.Refresh"/>

        <action id="Concord.Refresh.Dismiss"
                class="brig.concord.actions.DismissConcordRefreshAction"
                text="Dismiss"
                description="Hide this notification until the next change"
                icon="AllIcons.Actions.Close"/>
    </actions>

</idea-plugin>
